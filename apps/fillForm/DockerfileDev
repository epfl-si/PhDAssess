## Setup a meteor image in dev mode
#
ARG BASE_IMAGE=node:22-trixie

FROM $BASE_IMAGE

# Set up environment
ENV HOME=/home/node \
    BROWSERSLIST_IGNORE_OLD_DATA=1 \
    PATH=$PATH:/home/node/.meteor/

# Use node user (predefined in official Node image)
WORKDIR /app

# Copy source as root to preserve permissions
COPY . .

# Change ownership and permissions for OpenShift compatibility
RUN mkdir -p $HOME && \
    chown -R node:node $HOME && \
    chown -R node:node /app && \
    chmod -R 775 $HOME /app

# Switch to non-root user (node is UID 1000)
USER node

# Install Meteor in user space and set permissions about it
RUN HOME=/home/node npx meteor && \
    chmod -R a+rx /home/node/.meteor

# Install app
RUN meteor npm install

CMD meteor --settings=settings.json
